# AskAI CLI - Architecture Diagrams

# High-Level System Architecture
system_overview: {
  title: "AskAI CLI - System Overview"

  user: "User" {
    shape: person
    style.fill: "#E1F5FE"
  }

  cli: "CLI Interface" {
    shape: rectangle
    style.fill: "#F3E5F5"

    parser: "CLI Parser"
    commands: "Command Handler"
    banner: "Banner Display"
  }

  app: "Application Core" {
    shape: rectangle
    style.fill: "#E8F5E8"

    orchestrator: "Main Orchestrator (askai.py)"
    workflow: "Workflow Coordinator"
  }

  services: "Service Layer" {
    shape: rectangle
    style.fill: "#FFF3E0"

    ai_service: "AI Service"
    pattern_mgr: "Pattern Manager"
    chat_mgr: "Chat Manager"
    output_handler: "Output Handler"
    msg_builder: "Message Builder"
  }

  infrastructure: "Infrastructure" {
    shape: rectangle
    style.fill: "#FAFAFA"

    config: "Configuration"
    logging: "Logging"
    filesystem: "File System"
  }

  external: "External Services" {
    shape: rectangle
    style.fill: "#FFEBEE"

    openrouter: "OpenRouter API"
    ai_models: "AI Models"
  }

  # Connections
  user -> cli: "Commands & Input"
  cli -> app: "Parsed Arguments"
  app -> services: "Service Calls"
  services -> infrastructure: "System Resources"
  services -> external: "API Requests"
  external -> services: "AI Responses"
  services -> app: "Processed Results"
  app -> cli: "Formatted Output"
  cli -> user: "Results & Feedback"
}

# Component Dependencies and Relationships
component_relationships: {
  title: "Component Dependencies & Relationships"

  # Main Components
  main: "askai.py" {
    style.fill: "#4CAF50"
    style.stroke: "#2E7D32"
  }

  # CLI Layer
  cli_parser: "CLIParser" {
    style.fill: "#9C27B0"
  }
  command_handler: "CommandHandler" {
    style.fill: "#9C27B0"
  }
  banner_parser: "BannerArgumentParser" {
    style.fill: "#9C27B0"
  }

  # Service Layer
  ai_service: "AIService" {
    style.fill: "#FF9800"
  }
  openrouter_client: "OpenRouterClient" {
    style.fill: "#FF9800"
  }
  pattern_manager: "PatternManager" {
    style.fill: "#2196F3"
  }
  pattern_input: "PatternInput" {
    style.fill: "#2196F3"
  }
  pattern_output: "PatternOutput" {
    style.fill: "#2196F3"
  }
  chat_manager: "ChatManager" {
    style.fill: "#607D8B"
  }
  output_handler: "OutputHandler" {
    style.fill: "#795548"
  }
  file_writer: "FileWriter" {
    style.fill: "#795548"
  }
  message_builder: "MessageBuilder" {
    style.fill: "#009688"
  }

  # Infrastructure
  config: "Configuration" {
    style.fill: "#757575"
  }
  logger: "Logger" {
    style.fill: "#757575"
  }
  utils: "Utils" {
    style.fill: "#757575"
  }

  # Dependencies
  main -> cli_parser: "Argument Parsing"
  main -> command_handler: "Command Routing"
  main -> ai_service: "AI Interactions"
  main -> pattern_manager: "Pattern Processing"
  main -> chat_manager: "Chat Sessions"
  main -> output_handler: "Output Processing"
  main -> message_builder: "Message Construction"
  main -> config: "Configuration Loading"
  main -> logger: "Logging"

  cli_parser -> banner_parser: "Enhanced Help"
  command_handler -> pattern_manager: "Pattern Commands"
  command_handler -> chat_manager: "Chat Commands"
  command_handler -> openrouter_client: "API Commands"

  ai_service -> openrouter_client: "API Communication"
  ai_service -> config: "Model Configuration"

  pattern_manager -> pattern_input: "Input Validation"
  pattern_manager -> pattern_output: "Output Definition"
  pattern_manager -> config: "Private Patterns"

  output_handler -> file_writer: "File Operations"
  output_handler -> pattern_output: "Pattern Outputs"

  message_builder -> pattern_manager: "Pattern Templates"
  message_builder -> utils: "Content Processing"

  # All components use logger and utils
  cli_parser -> logger
  command_handler -> logger
  ai_service -> logger
  pattern_manager -> logger
  chat_manager -> logger
  output_handler -> logger
  message_builder -> logger
}

# Data Flow for Pattern Processing
pattern_flow: {
  title: "Pattern Processing Data Flow"

  user_input: "User Input" {
    shape: oval
    style.fill: "#E3F2FD"
  }

  cli_parse: "CLI Parsing" {
    shape: diamond
    style.fill: "#F3E5F5"
  }

  pattern_select: "Pattern Selection" {
    shape: rectangle
    style.fill: "#E8F5E8"
  }

  input_collect: "Input Collection" {
    shape: rectangle
    style.fill: "#E8F5E8"
  }

  msg_build: "Message Building" {
    shape: rectangle
    style.fill: "#FFF3E0"
  }

  ai_process: "AI Processing" {
    shape: rectangle
    style.fill: "#FFEBEE"
  }

  response_parse: "Response Parsing" {
    shape: rectangle
    style.fill: "#F3E5F5"
  }

  output_process: "Output Processing" {
    shape: rectangle
    style.fill: "#E0F2E1"
  }

  file_gen: "File Generation" {
    shape: parallelogram
    style.fill: "#FFF8E1"
  }

  display: "Display Results" {
    shape: oval
    style.fill: "#E8EAF6"
  }

  # Flow connections
  user_input -> cli_parse: "Command & Args"
  cli_parse -> pattern_select: "Pattern ID"
  pattern_select -> input_collect: "Pattern Definition"
  input_collect -> msg_build: "Validated Inputs"
  msg_build -> ai_process: "Formatted Messages"
  ai_process -> response_parse: "AI Response"
  response_parse -> output_process: "Structured Data"
  output_process -> file_gen: "File Content"
  output_process -> display: "Console Output"
  file_gen -> display: "File Paths"

  # Error flows
  cli_parse -> display: "Help/Errors" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
  pattern_select -> display: "Pattern Errors" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
  input_collect -> display: "Validation Errors" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
  ai_process -> display: "API Errors" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
}

# Chat Session Management
chat_flow: {
  title: "Chat Session Management Flow"

  chat_request: "Chat Request" {
    shape: oval
    style.fill: "#E3F2FD"
  }

  session_check: "Session Check" {
    shape: diamond
    style.fill: "#F3E5F5"
  }

  new_session: "Create New Session" {
    shape: rectangle
    style.fill: "#E8F5E8"
  }

  load_history: "Load Chat History" {
    shape: rectangle
    style.fill: "#FFF3E0"
  }

  context_build: "Build Context" {
    shape: rectangle
    style.fill: "#FFEBEE"
  }

  ai_call: "AI Service Call" {
    shape: rectangle
    style.fill: "#F3E5F5"
  }

  response_process: "Process Response" {
    shape: rectangle
    style.fill: "#E0F2E1"
  }

  store_history: "Store in History" {
    shape: rectangle
    style.fill: "#FFF8E1"
  }

  display_result: "Display Result" {
    shape: oval
    style.fill: "#E8EAF6"
  }

  # Main flow
  chat_request -> session_check: "Chat ID"
  session_check -> new_session: "New Session"
  session_check -> load_history: "Existing Session"
  new_session -> context_build: "Empty Context"
  load_history -> context_build: "Historical Context"
  context_build -> ai_call: "Complete Messages"
  ai_call -> response_process: "AI Response"
  response_process -> store_history: "Formatted Output"
  response_process -> display_result: "User Output"
  store_history -> display_result: "Success Confirmation"
}

# Configuration and Initialization
config_flow: {
  title: "Configuration & Initialization Flow"

  startup: "Application Startup" {
    shape: oval
    style.fill: "#E3F2FD"
  }

  dir_check: "Directory Check" {
    shape: diamond
    style.fill: "#F3E5F5"
  }

  create_dirs: "Create Directories" {
    shape: rectangle
    style.fill: "#E8F5E8"
  }

  config_check: "Config File Check" {
    shape: diamond
    style.fill: "#FFF3E0"
  }

  setup_wizard: "Setup Wizard" {
    shape: rectangle
    style.fill: "#FFEBEE"
  }

  load_config: "Load Configuration" {
    shape: rectangle
    style.fill: "#F3E5F5"
  }

  init_components: "Initialize Components" {
    shape: rectangle
    style.fill: "#E0F2E1"
  }

  ready: "Application Ready" {
    shape: oval
    style.fill: "#E8EAF6"
  }

  # Flow connections
  startup -> dir_check: "Check ~/.askai"
  dir_check -> create_dirs: "Missing"
  dir_check -> config_check: "Exists"
  create_dirs -> config_check: "Created"
  config_check -> setup_wizard: "Missing Config"
  config_check -> load_config: "Config Exists"
  setup_wizard -> load_config: "Config Created"
  load_config -> init_components: "Valid Config"
  init_components -> ready: "All Components Ready"

  # Error handling
  dir_check -> startup: "Permission Error" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
  config_check -> startup: "Invalid Config" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
  setup_wizard -> startup: "Setup Cancelled" {
    style.stroke-dash: 5
    style.stroke: "#F44336"
  }
}

# Pattern System Architecture
pattern_architecture: {
  title: "Pattern System Architecture"

  # Pattern Storage
  storage: "Pattern Storage" {
    shape: cylinder
    style.fill: "#E1F5FE"

    builtin: "Built-in Patterns"
    private: "Private Patterns"
  }

  # Pattern Manager
  manager: "Pattern Manager" {
    style.fill: "#F3E5F5"

    loader: "Pattern Loader"
    validator: "Input Validator"
    selector: "Pattern Selector"
  }

  # Pattern Components
  components: "Pattern Components" {
    style.fill: "#E8F5E8"

    inputs: "Pattern Inputs"
    outputs: "Pattern Outputs"
    config: "Pattern Configuration"
  }

  # Processing Pipeline
  pipeline: "Processing Pipeline" {
    style.fill: "#FFF3E0"

    template: "Template Engine"
    formatter: "Format Instructions"
    executor: "Output Executor"
  }

  # Output Handlers
  outputs: "Output Handlers" {
    style.fill: "#FFEBEE"

    display: "Display Handler"
    file: "File Writer"
    command: "Command Executor"
  }

  # Connections
  storage -> manager: "Load Patterns"
  manager -> components: "Parse Definition"
  components -> pipeline: "Process Template"
  pipeline -> outputs: "Execute Outputs"

  # Internal connections
  manager.loader -> storage.builtin: "Load Built-in"
  manager.loader -> storage.private: "Load Private"
  manager.validator -> components.inputs: "Validate"
  manager.selector -> components.config: "Configure"

  pipeline.template -> components.outputs: "Apply Template"
  pipeline.formatter -> components.config: "Format Instructions"
  pipeline.executor -> outputs.display: "Display"
  pipeline.executor -> outputs.file: "Write Files"
  pipeline.executor -> outputs.command: "Execute Commands"
}

# AI Service Integration
ai_integration: {
  title: "AI Service Integration Architecture"

  # Application Layer
  app_layer: "Application Layer" {
    style.fill: "#E3F2FD"

    ai_service: "AI Service"
    model_config: "Model Configuration"
  }

  # Client Layer
  client_layer: "Client Layer" {
    style.fill: "#F3E5F5"

    openrouter: "OpenRouter Client"
    web_search: "Web Search Plugin"
    multimodal: "Multimodal Handler"
  }

  # External Services
  external: "External Services" {
    style.fill: "#E8F5E8"

    openrouter_api: "OpenRouter API"
    ai_models: "AI Models"
    web_services: "Web Services"
  }

  # Message Processing
  message_proc: "Message Processing" {
    style.fill: "#FFF3E0"

    builder: "Message Builder"
    encoder: "Content Encoder"
    formatter: "Format Handler"
  }

  # Response Processing
  response_proc: "Response Processing" {
    style.fill: "#FFEBEE"

    parser: "Response Parser"
    extractor: "Content Extractor"
    validator: "Response Validator"
  }

  # Connections
  app_layer -> message_proc: "Build Messages"
  message_proc -> client_layer: "Formatted Messages"
  client_layer -> external: "API Requests"
  external -> client_layer: "API Responses"
  client_layer -> response_proc: "Raw Responses"
  response_proc -> app_layer: "Processed Results"

  # Internal flows
  app_layer.ai_service -> app_layer.model_config: "Configure"
  app_layer.model_config -> client_layer.openrouter: "Model Settings"

  client_layer.web_search -> external.web_services: "Search Queries"
  client_layer.multimodal -> external.ai_models: "Multimodal Content"

  message_proc.builder -> message_proc.encoder: "Content"
  message_proc.encoder -> message_proc.formatter: "Encoded Content"

  response_proc.parser -> response_proc.extractor: "Parsed Data"
  response_proc.extractor -> response_proc.validator: "Extracted Content"
}

# Error Handling and Recovery
error_handling: {
  title: "Error Handling & Recovery System"

  # Error Sources
  sources: "Error Sources" {
    style.fill: "#FFEBEE"

    cli_errors: "CLI Errors"
    config_errors: "Config Errors"
    api_errors: "API Errors"
    file_errors: "File I/O Errors"
    validation_errors: "Validation Errors"
  }

  # Error Handlers
  handlers: "Error Handlers" {
    style.fill: "#FFF3E0"

    cli_handler: "CLI Error Handler"
    api_handler: "API Error Handler"
    file_handler: "File Error Handler"
    validation_handler: "Validation Handler"
  }

  # Recovery Strategies
  recovery: "Recovery Strategies" {
    style.fill: "#E8F5E8"

    retry: "Retry Logic"
    fallback: "Fallback Options"
    graceful: "Graceful Degradation"
    user_prompt: "User Interaction"
  }

  # Logging and Monitoring
  monitoring: "Logging & Monitoring" {
    style.fill: "#F3E5F5"

    logger: "Error Logger"
    metrics: "Error Metrics"
    alerts: "User Alerts"
  }

  # User Feedback
  feedback: "User Feedback" {
    style.fill: "#E1F5FE"

    messages: "Error Messages"
    suggestions: "Recovery Suggestions"
    help: "Help Information"
  }

  # Error flow
  sources -> handlers: "Catch Errors"
  handlers -> recovery: "Apply Strategy"
  handlers -> monitoring: "Log Errors"
  recovery -> feedback: "User Guidance"
  monitoring -> feedback: "Status Updates"

  # Specific error handling flows
  sources.cli_errors -> handlers.cli_handler: "Parse Errors"
  sources.api_errors -> handlers.api_handler: "Network/API Errors"
  sources.file_errors -> handlers.file_handler: "I/O Errors"
  sources.validation_errors -> handlers.validation_handler: "Data Errors"

  handlers.api_handler -> recovery.retry: "Transient Errors"
  handlers.file_handler -> recovery.fallback: "Missing Files"
  handlers.validation_handler -> recovery.user_prompt: "Invalid Input"
}
