# AskAI CLI - Pattern Processing Data Flow (CLI and API Access)
title: "Pattern Processing Data Flow"

user_input: "CLI User Input" {
  shape: oval
  style.fill: "#90CAF9" # Light Blue (core app)
}

api_request: "API HTTP Request" {
  shape: oval
  style.fill: "#FFB74D" # Light Orange (external)
}

# Presentation Layer
presentation: "Presentation Layer" {
  shape: rectangle
  style.fill: "#F3E5F5" # Light Purple background

  cli_parse: "CLI Parsing" {
    shape: diamond
    style.fill: "#CE93D8" # Light Purple (CLI)
  }

  api_routes: "API Routes" {
    shape: diamond
    style.fill: "#BA68C8" # Darker Purple (API)
  }
}

# Modules Layer
modules: "Modules Layer" {
  shape: rectangle
  style.fill: "#E8F5E9" # Light Green background

  pattern_select: "Pattern Selection\n(patterns/)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green (data processing)
  }

  input_collect: "Input Collection\n(patterns/)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green
  }

  msg_build: "Message Building\n(messaging/)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green
  }

  ai_process: "AI Processing\n(ai/)" {
    shape: rectangle
    style.fill: "#81C784" # Slightly different green for AI
  }
}

# Infrastructure Layer
infrastructure: "Infrastructure Layer" {
  shape: rectangle
  style.fill: "#FFF9C4" # Light Yellow background

  content_extract: "Content Extraction\n(output/processors/)" {
    shape: rectangle
    style.fill: "#FFF176" # Light Yellow
  }

  order_process: "Definition Order Processing\n(output/)" {
    shape: rectangle
    style.fill: "#FFF176" # Light Yellow
  }

  display: "Display Results\n(output/formatters/)" {
    shape: oval
    style.fill: "#FFF176" # Light Yellow
  }

  deferred_ops: "Execute Deferred Operations\n(output/)" {
    shape: rectangle
    style.fill: "#FFF176" # Light Yellow
  }

  file_gen: "File Generation\n(output/file_writers/)" {
    shape: parallelogram
    style.fill: "#FFEB3B" # Brighter yellow
  }

  command_exec: "Command Execution\n(output/)" {
    shape: parallelogram
    style.fill: "#F8BBD9" # Light Pink (actions)
  }
}

# External Services
external: "External Services" {
  shape: rectangle
  style.fill: "#FFF3E0" # Light Orange

  openrouter: "OpenRouter API" {
    shape: rectangle
    style.fill: "#FFCC80" # Light Orange
  }
}

# Layer Flow (Main Paths)
user_input -> presentation: "CLI Command & Args"
api_request -> presentation: "HTTP POST Request"
presentation -> modules: "Parsed Arguments/JSON"
modules -> external: "AI Messages"
external -> infrastructure: "AI Response"
infrastructure -> presentation: "Formatted Output"
presentation -> user_input: "CLI Results & Feedback"
presentation -> api_request: "JSON Response"

# Detailed Component Flow (CLI Path)
user_input -> presentation.cli_parse: "Command Line"
presentation.cli_parse -> modules.pattern_select: "Pattern ID"

# Detailed Component Flow (API Path)
api_request -> presentation.api_routes: "HTTP Request"
presentation.api_routes -> modules.pattern_select: "Pattern ID from JSON"

# Shared Module Processing
modules.pattern_select -> modules.input_collect: "Pattern Definition"
modules.input_collect -> modules.msg_build: "Validated Inputs"
modules.msg_build -> modules.ai_process: "Formatted Messages"
modules.ai_process -> external.openrouter: "HTTP Request"
external.openrouter -> infrastructure.content_extract: "AI Response"
infrastructure.content_extract -> infrastructure.order_process: "Structured Data"
infrastructure.order_process -> infrastructure.display: "Display Content (First)"
infrastructure.display -> infrastructure.deferred_ops: "After Display Shown"
infrastructure.deferred_ops -> infrastructure.file_gen: "File Operations"
infrastructure.deferred_ops -> infrastructure.command_exec: "Commands (if any)"
infrastructure.file_gen -> infrastructure.display: "File Creation Results"
infrastructure.command_exec -> infrastructure.display: "Command Results"

# Enhanced processing notes
infrastructure.content_extract: {
  label: "• JSON parsing\n• Malformed JSON fallback\n• Pattern-specific extraction"
}

infrastructure.order_process: {
  label: "• Respects pattern definition order\n• Immediate displays\n• Deferred files & commands"
}

# Error flows (Layer-aware)
presentation.cli_parse -> infrastructure.display: "CLI Help/Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red (error)
}
presentation.api_routes -> infrastructure.display: "API Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red (error)
}
modules.pattern_select -> infrastructure.display: "Pattern Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red
}
modules.input_collect -> infrastructure.display: "Validation Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red
}
external.openrouter -> infrastructure.display: "API Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red
}
infrastructure.content_extract -> infrastructure.display: "Extraction Errors" {
  style.stroke-dash: 5
  style.stroke: "#EF9A9A" # Light Red
}
