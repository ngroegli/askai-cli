name: Python Linting

on:
  pull_request:
    branches: ["main", "develop"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Set up the environment properly
          echo "PYTHONPATH=.:$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Analyze code with Pylint
        id: pylint_run
        run: |
          # Make sure there are Python files to analyze
          PYTHON_FILES=$(find ./python -name "*.py" | xargs)
          if [ -z "$PYTHON_FILES" ]; then
            echo "No Python files found to analyze! Check the paths and file structure."
            exit 0
          fi

          # Saving the list of Python files for later use
          echo "$PYTHON_FILES" > python_files.txt

          echo "::group::Full Pylint Output"
          # Run pylint using the project's configuration file with full output
          # Run pylint but don't fail the build based on this run
          PYTHONPATH=python pylint --rcfile=.pylintrc $PYTHON_FILES || echo "Pylint check found issues but we'll only fail on critical errors"
          echo "::endgroup::"

      - name: Check issues by severity
        run: |
          # Use the saved list of Python files
          PYTHON_FILES=$(cat python_files.txt)
          if [ -z "$PYTHON_FILES" ]; then
            echo "No Python files found to analyze! Check the paths and file structure."
            exit 0  # Don't fail if no files found
          fi

          # Extract disabled warnings from .pylintrc to apply consistently
          DISABLED_CHECKS=$(grep -oP '^disable=\K.*' .pylintrc)
          echo "Applying disabled warnings from .pylintrc: $DISABLED_CHECKS"

          echo "## Pylint Results by Severity" >> $GITHUB_STEP_SUMMARY

          # 1. Check for critical errors (error category) - fail if any are found
          echo "::group::CRITICAL ERRORS (E) - These will block merging"
          CRITICAL_ERRORS=$(PYTHONPATH=python pylint --rcfile=.pylintrc --disable=C,W,R,I --enable=E --disable=$DISABLED_CHECKS --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")
          CRITICAL_EXIT_CODE=${PIPESTATUS[0]}

          if [ -n "$CRITICAL_ERRORS" ]; then
            echo "$CRITICAL_ERRORS"
            echo "### ❌ CRITICAL ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CRITICAL_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No critical errors found."
            echo "### ✅ No critical errors found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          # 2. Check for warnings - these are important but we'll just report them
          echo -e "\n::group::WARNINGS (W) - These should be addressed but won't block merging"
          # Keep the warnings disabled in .pylintrc also disabled here
          WARNINGS=$(PYTHONPATH=python pylint --rcfile=.pylintrc --disable=C,E,R,I --enable=W --disable=$DISABLED_CHECKS --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          if [ -n "$WARNINGS" ]; then
            echo "$WARNINGS"
            echo "### ⚠️ WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No warnings found."
            echo "### ✅ No warnings found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          # 3. Check for refactoring suggestions - just for information
          echo -e "\n::group::REFACTORING SUGGESTIONS (R) - Recommendations to improve code quality"
          REFACTORING=$(PYTHONPATH=python pylint --rcfile=.pylintrc --disable=C,E,W,I --enable=R --disable=$DISABLED_CHECKS --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          if [ -n "$REFACTORING" ]; then
            echo "$REFACTORING"
            echo "### 🔧 REFACTORING SUGGESTIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$REFACTORING" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No refactoring suggestions found."
            echo "### ✅ No refactoring suggestions" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          # 4. Check for convention violations - just for information
          echo -e "\n::group::CONVENTION ISSUES (C) - Style suggestions"
          CONVENTIONS=$(PYTHONPATH=python pylint --rcfile=.pylintrc --disable=E,W,R,I --enable=C --disable=$DISABLED_CHECKS --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          if [ -n "$CONVENTIONS" ]; then
            echo "$CONVENTIONS"
            echo "### 📝 CONVENTION ISSUES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CONVENTIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No convention issues found."
            echo "### ✅ No convention issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          # 5. Check for info messages - just for information
          echo -e "\n::group::INFORMATION (I) - Additional info"
          INFORMATION=$(PYTHONPATH=python pylint --rcfile=.pylintrc --disable=E,W,R,C --enable=I --disable=$DISABLED_CHECKS --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          if [ -n "$INFORMATION" ]; then
            echo "$INFORMATION"
            echo "### ℹ️ INFORMATION" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$INFORMATION" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No information messages found."
            echo "### ✅ No information messages" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          # Determine if the build should fail (only critical errors cause failure)
          if [ "$CRITICAL_EXIT_CODE" = "4" ]; then
            echo "Exit code 4 detected (no files found or config issue). This is not a critical error."
            exit 0  # Don't fail the build for this
          elif [ "$CRITICAL_EXIT_CODE" != "0" ]; then
            echo "::error::Critical errors found. Failing the build."
            exit 1
          else
            echo "No critical errors found that would block merging."
          fi
